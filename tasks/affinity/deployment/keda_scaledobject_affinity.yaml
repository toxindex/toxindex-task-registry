# KEDA ScaledObject for Celery Affinity Worker
# Watches the Redis queue and scales from 0 when tasks arrive
#
# Prerequisites:
# 1. Install KEDA in the cluster:
#    kubectl apply --server-side -f https://github.com/kedacore/keda/releases/download/v2.13.0/keda-2.13.0.yaml
#
# 2. Create the Redis connection secret (TriggerAuthentication):
#    kubectl apply -f keda_trigger_auth_affinity.yaml
#
# 3. Apply this ScaledObject:
#    kubectl apply -f keda_scaledobject_affinity.yaml
#
# Note: When using KEDA, you can remove or keep the HPA. KEDA will manage scaling
# including scale-to-zero. If you keep HPA with minReplicas: 0, KEDA handles 0→1
# and HPA handles 1→N scaling.

apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: celery-worker-affinity-scaledobject
  namespace: toxindex-app
spec:
  scaleTargetRef:
    name: celery-worker-affinity
    kind: Deployment

  # Polling interval - how often KEDA checks the queue
  pollingInterval: 15  # seconds

  # Cooldown period before scaling to zero after queue is empty
  cooldownPeriod: 300  # 5 minutes - gives time for any follow-up tasks

  # Idle replica count (scale to this when no triggers are active)
  idleReplicaCount: 1  # Keep 1 warm to avoid cold start (~2-5 min GPU provisioning)

  # Min/max replicas when active
  minReplicaCount: 1   # At least 1 when there are tasks
  maxReplicaCount: 10  # Match HPA max (A100s are expensive)

  # Advanced scaling behavior
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 60
          policies:
          - type: Percent
            value: 50
            periodSeconds: 30
        scaleUp:
          stabilizationWindowSeconds: 0
          policies:
          - type: Pods
            value: 2
            periodSeconds: 15

  triggers:
  # Watch the Celery queue in Redis
  - type: redis
    metadata:
      # Redis connection details
      address: "10.238.5.54:6379"  # Your Redis host:port

      # Celery uses Redis lists for task queues
      # Queue name format: celery (default) or custom queue name
      listName: "affinity"  # The Celery queue name for affinity tasks
      listLength: "1"       # Scale up when there's at least 1 task in queue

      # Optional: Use activationListLength to set threshold for 0→1 scaling
      # activationListLength: "1"  # Minimum queue length to activate scaling from 0

      # Database number (Celery default is 0)
      databaseIndex: "0"

    # Authentication reference (if Redis requires password)
    # Uncomment if your Redis requires authentication
    # authenticationRef:
    #   name: keda-redis-auth
